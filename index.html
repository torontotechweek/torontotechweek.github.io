<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
	<script src="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.css" rel="stylesheet" />
	<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="torontotechweek.css">
</head>

<body>

	<div id="map"></div>

	<script>

		zoomThreshold = 14

		const map = new maplibregl.Map({
			container: 'map',
			style: {
				version: 8,
				glyphs: 'assets/fonts/{fontstack}/{range}.pbf',
				sprite: 'http://localhost:8000/assets/sprites/sprites',
				sources: {
					'osm': {
						type: 'raster',
						tiles: ['https://a.tile.openstreetmap.org/{z}/{x}/{y}.png'],
						tileSize: 256,
						attribution: '&copy; OpenStreetMap Contributors'
					}
				},
				layers: [
					{
						id: 'osm',
						type: 'raster',
						source: 'osm',
						paint: {
							'raster-hue-rotate': 0,
							'raster-contrast': 0.2,
							'raster-saturation': -1,
							'raster-brightness-min': 0.5,
							'raster-brightness-max': 1,
							'raster-opacity': 1
						}
					}
				]
			},
			center: [-79.385015, 43.64507],
			zoom: 16,
			bearing: 0,
			pitch: 0,
			pixelRatio: 1,
			hash: true
		});

		map.on('load', () => {

			// Add building source
			map.addSource('toronto_buildings', {
				type: 'vector',
				tiles: ['https://torontotechweek.github.io/data/toronto_buildings/{z}/{x}/{y}.pbf']
			});

			// Add buildings
			map.addLayer(
				{
					'id': 'buildings',
					'source': 'toronto_buildings',
					'source-layer': 'toronto_buildings',
					'type': 'fill-extrusion',
					'paint': {
						'fill-extrusion-color': 'hsl(0, 0%, 100%)',
						'fill-extrusion-height': [
							'interpolate',
							['linear'],
							['zoom'],
							15, 0,
							16, [
								'case',
								['!=', ['get', 'max_height'], null], ['*', ['get', 'max_height'], 1.5],
								['!=', ['get', 'avg_height'], null], ['*', ['get', 'avg_height'], 1.5],
								10
							]
						],
						'fill-extrusion-base': 0,
						'fill-extrusion-opacity': 0.5
					},
					'minzoom': 15
				}
			);

			// Add neighborhood source
			map.addSource('toronto_neighborhoods', {
				type: 'vector',
				tiles: ['http://localhost:8000/data/toronto_neighborhoods/{z}/{x}/{y}.pbf']
			});

			// Add neighborhood fill
			map.addLayer(
				{
					'id': 'neighborhoods',
					'source': 'toronto_neighborhoods',
					'source-layer': 'toronto_neighborhoods',
					'type': 'fill',
					'paint': {
						'fill-color': 'hsl(20, 50%, 70%)',
						'fill-opacity': 0
					}
				}
			);

			// Add neighborhood outlines
			map.addLayer({
				'id': 'neighborhoods-outlines',
				'source': 'toronto_neighborhoods',
				'source-layer': 'toronto_neighborhoods',
				'type': 'line',
				'paint': {
					'line-color': 'hsl(20, 50%, 70%)',
					'line-width': 3,
					'line-opacity': 0.8
				}
			});

			// Add neighborhood centroid source
			map.addSource('toronto_neighborhoods_centroids', {
				type: 'vector',
				tiles: ['http://localhost:8000/data/toronto_neighborhoods_centroids/{z}/{x}/{y}.pbf']
			});

			map.addLayer({
				id: 'neighborhoods-labels',
				type: 'symbol',
				source: 'toronto_neighborhoods_centroids',
				'source-layer': 'toronto_neighborhoods_centroids',
				layout: {
					'text-field': ['get', 'area_name'],
					'text-size': 16,
					'text-font': ['inter-medium'],
					'text-max-width': 10,
					'text-line-height': 1.2,
					'text-allow-overlap': true,
					'text-ignore-placement': true,
					'text-rotation-alignment': 'viewport',
					'text-pitch-alignment': 'map'  
				},
				paint: {
					'text-color': 'hsl(0, 0%, 0%)',
					'text-opacity': 0.5,
					'text-halo-color': 'hsl(0, 0%, 100%)',
					'text-halo-width': 1.5
				}
			});

			// Add event source
			map.addSource('events', {
				'type': 'geojson',
				'data': 'data/ttw2025_with_buildings.geojson',
				'cluster': true,
				'clusterRadius': 20,
				'clusterMinPoints': 3,
				'clusterMaxZoom': zoomThreshold - 1
			});

			// Add cluster circles
			map.addLayer({
				id: 'clusters',
				type: 'circle',
				source: 'events',
				filter: ['has', 'point_count'],
				paint: {
					'circle-color': [
						'step',
						['get', 'point_count'],
						'hsl(0, 0%, 20%)',
						10, 'hsl(0, 0%, 10%)',
						25, 'hsl(0, 0%, 0%)'
					],
					'circle-radius': [
						'step',
						['get', 'point_count'],
						15,
						10, 20,
						25, 25
					],
					'circle-stroke-width': 1.5,
					'circle-stroke-color': 'hsl(0, 0%, 100%)',
				},
				'maxzoom': zoomThreshold
			});

			// Add cluster count
			map.addLayer({
				id: 'cluster-count',
				type: 'symbol',
				source: 'events',
				filter: ['has', 'point_count'],
				layout: {
					'text-field': '{point_count_abbreviated}',
					'text-font': ['inter-medium'],
					'text-size': 12
				},
				paint: {
					'text-color': 'hsl(0, 0%, 100%)'
				},
				'maxzoom': zoomThreshold
			});

			// Add event points
			map.addLayer({
				id: 'points',
				type: 'circle',
				source: 'events',
				filter: ['!', ['has', 'point_count']],
				paint: {
					'circle-radius': 5,
					'circle-color': 'hsl(0, 0%, 0%)',
					'circle-stroke-width': 1.5,
					'circle-stroke-color': 'hsl(0, 0%, 100%)'
				}
			});

			map.setLight({
				'anchor': 'viewport',
				'color': 'hsl(0, 0%, 100%)',
				'intensity': 0.5,
				'position': [1.15, 210, 40]
			});

		});

	</script>
</body>

</html>