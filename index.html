<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
	<script src="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.css" rel="stylesheet" />
	<link rel="stylesheet" href="torontotechweek.css">
</head>

<body>

	<div id="map"></div>

	<script>

		zoomThreshold = 14

		var map = new maplibregl.Map({
			container: 'map',
			style: 'torontotechweek.json',
			center: [-79.393658, 43.654489], //toronto
			//center: [ -80.5449, 43.4706 ], //waterloo
			pixelRatio: 1,
			zoom: 16,
			maxZoom: 20,
			bearing: 0,
			pitch: 40,
			hash: true
		});

		map.on('load', () => {

			// Add building source
			map.addSource('toronto_buildings', {
				type: 'vector',
				tiles: ['https://torontotechweek.github.io/data/toronto_buildings/{z}/{x}/{y}.pbf']
			});

			// Add building extrusions
			map.addLayer(
				{
					'id': 'buildings',
					'source': 'toronto_buildings',
					'source-layer': 'toronto_buildings',
					'type': 'fill-extrusion',
					'paint': {
						'fill-extrusion-color': 'hsl(0, 0%, 100%)',
						'fill-extrusion-height': [
							'case',
							['!=', ['get', 'max_height'], null], ['get', 'max_height'],
							['!=', ['get', 'avg_height'], null], ['get', 'avg_height'],
							10
						],
						'fill-extrusion-base': 0,
						"fill-extrusion-opacity": [
							"interpolate",
							["exponential", 0.5],
							["zoom"],
							15, 0, 16, 0.5
						]
					}
				}
			);

			// Add event source
			map.addSource('events', {
				'type': 'geojson',
				'data': 'data/ttw2025.geojson',
				'cluster': true,
				'clusterRadius': 20,
				'clusterMinPoints': 3,
				'clusterMaxZoom': zoomThreshold - 1
			});

			// Add cluster circles
			map.addLayer({
				id: 'clusters',
				type: 'circle',
				source: 'events',
				filter: ['has', 'point_count'],
				paint: {
					'circle-color': [
						'step',
						['get', 'point_count'],
						'hsl(270, 29%, 90%)',
						10, 'hsl(270, 29%, 80%)',
						25, 'hsl(270, 29%, 70%)'
					],
					'circle-radius': [
						'step',
						['get', 'point_count'],
						15,
						10, 20,
						25, 25
					],
					'circle-stroke-width': 1,
					'circle-stroke-color': 'hsl(0, 0%, 30%)',
				},
				'maxzoom': zoomThreshold
			});

			// Add cluster count
			map.addLayer({
				id: 'cluster-count',
				type: 'symbol',
				source: 'events',
				filter: ['has', 'point_count'],
				layout: {
					'text-field': '{point_count_abbreviated}',
					'text-font': ['notosans-regular'],
					'text-size': 12
				},
				paint: {
					'text-color': 'hsl(0, 0%, 0%)'
				},
				'maxzoom': zoomThreshold
			});

			// Add event points
			map.addLayer({
				id: 'points',
				type: 'circle',
				source: 'events',
				filter: ['!', ['has', 'point_count']],
				paint: {
					'circle-radius': 5,
					'circle-color': 'hsl(0, 0%, 0%)',
					'circle-stroke-width': 1.5,
					'circle-stroke-color': 'hsl(0, 0%, 100%)'
				}
			});

			map.setLight({
				'anchor': 'viewport',
				'color': 'hsl(0, 0%, 100%)',
				'intensity': 0.5,
				'position': [1.15, 210, 40]
			});

		});

	</script>
</body>

</html>