<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
	<script src="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.js"></script>
	<link href="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.css" rel="stylesheet" />
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
		rel="stylesheet">
	<link rel="stylesheet" href="style.css">
</head>

<body>

	<div id="map"></div>
	<div id="category-box"></div>

	<script>

		const locationFile = 'data/ttw2025_with_buildings.geojson'
		const zoomThreshold = 14
		let currentActiveCategory = 'all';
		let locationData;

		const map = new maplibregl.Map({
			container: 'map',
			style: {
				version: 8,
				glyphs: 'assets/fonts/{fontstack}/{range}.pbf',
				sprite: 'http://localhost:8000/assets/sprites/sprites',
				sources: {
					'osm': {
						type: 'raster',
						tiles: ['https://a.tile.openstreetmap.org/{z}/{x}/{y}.png'],
						tileSize: 256,
						attribution: '&copy; OpenStreetMap Contributors'
					}
				},
				layers: [
					{
						id: 'osm',
						type: 'raster',
						source: 'osm',
						paint: {
							'raster-hue-rotate': 0,
							'raster-contrast': 0.2,
							'raster-saturation': -1,
							'raster-brightness-min': 0.5,
							'raster-brightness-max': 1,
							'raster-opacity': 1
						}
					}
				]
			},
			center: [-79.385015, 43.64507],
			zoom: 15,
			minZoom: 11,
			maxZoom: 18,
			//maxBounds: [ [-79.56729275921924, 43.56518035854518],[-79.27118684581397, 43.728046474967954] ],
			bearing: 0,
			pitch: 0,
			pixelRatio: 1,
			hash: true
		});

		map.on('load', () => {

			fetch(locationFile)
				.then(res => res.json())
				.then(data => {
					locationData = data;

					// Add building source
					map.addSource('toronto_buildings', {
						type: 'vector',
						tiles: ['https://torontotechweek.github.io/data/toronto_buildings/{z}/{x}/{y}.pbf']
					});

					// Add neighborhood source
					map.addSource('toronto_neighborhoods', {
						type: 'vector',
						tiles: ['https://torontotechweek.github.io/data/toronto_neighborhoods/{z}/{x}/{y}.pbf']
					});

					// Add neighborhood centroids
					map.addSource('toronto_neighborhoods_centroids', {
						'type': 'geojson',
						'data': 'data/toronto_neighborhoods_centroids.geojson'
					});

					// Add event source
					map.addSource('events', {
						'type': 'geojson',
						'data': locationData,
						'cluster': true,
						'clusterRadius': 20,
						'clusterMinPoints': 3,
						'clusterMaxZoom': zoomThreshold - 1
					});

					// Add neighborhood outlines
					map.addLayer({
						'id': 'neighborhoods-outlines',
						'source': 'toronto_neighborhoods',
						'source-layer': 'toronto_neighborhoods',
						'type': 'line',
						'paint': {
							'line-color': 'hsl(20, 50%, 70%)',
							'line-width': ['interpolate', ['exponential', 1.1], ['zoom'], 10, 1, 18, 3],
							'line-opacity': 0.8
						}
					});

					// Add buildings
					map.addLayer(
						{
							'id': 'buildings',
							'source': 'toronto_buildings',
							'source-layer': 'toronto_buildings',
							'type': 'fill-extrusion',
							'paint': {
								'fill-extrusion-color': 'hsl(0, 0%, 100%)',
								'fill-extrusion-height': [
									'interpolate',
									['linear'],
									['zoom'],
									15, 0,
									16, [
										'case',
										['!=', ['get', 'max_height'], null], ['get', 'max_height'],
										['!=', ['get', 'avg_height'], null], ['get', 'avg_height'],
										10
									]
								],
								'fill-extrusion-base': 0,
								'fill-extrusion-opacity': 0.5
							},
							'minzoom': 15
						}
					);

					// Add neighborhood fill
					map.addLayer(
						{
							'id': 'neighborhoods',
							'source': 'toronto_neighborhoods',
							'source-layer': 'toronto_neighborhoods',
							'type': 'fill',
							'paint': {
								'fill-color': 'hsl(20, 50%, 70%)',
								'fill-opacity': 0
							}
						}
					);

					// Add neighborhood labels
					map.addLayer({
						id: 'neighborhoods-labels',
						type: 'symbol',
						source: 'toronto_neighborhoods_centroids',
						'source-layer': 'toronto_neighborhoods_centroids',
						layout: {
							'text-field': ['get', 'area_name'],
							'text-size': ['interpolate', ['exponential', 1.1], ['zoom'], 10, 1, 18, 50],
							'text-font': ['inter-medium'],
							'text-max-width': 5,
							'text-line-height': 1,
							'text-allow-overlap': true,
							'text-ignore-placement': true,
							//'text-variable-anchor': ['top', 'bottom', 'left', 'right'],
							'text-rotation-alignment': 'viewport',
							'text-pitch-alignment': 'map'
						},
						paint: {
							'text-color': 'hsl(20, 50%, 70%)',
							'text-opacity': 0.8,
						}
					});

					// Add event points
					map.addLayer({
						id: 'points',
						type: 'circle',
						source: 'events',
						filter: ['!', ['has', 'point_count']],
						paint: {
							'circle-radius': 5,
							'circle-color': 'hsl(0, 0%, 0%)',
							'circle-stroke-width': 1.5,
							'circle-stroke-color': 'hsl(0, 0%, 100%)'
						}
					});

					// Add cluster circles
					map.addLayer({
						id: 'clusters',
						type: 'circle',
						source: 'events',
						filter: ['has', 'point_count'],
						paint: {
							'circle-color': [
								'step',
								['get', 'point_count'],
								'hsl(0, 0%, 0%)',
								10, 'hsl(0, 0%, 0%)',
								25, 'hsl(0, 0%, 0%)'
							],
							'circle-radius': [
								'step',
								['get', 'point_count'],
								15,
								10, 20,
								25, 25
							],
							'circle-stroke-width': 1.5,
							'circle-stroke-color': 'hsl(0, 0%, 100%)',
						},
						'maxzoom': zoomThreshold
					});

					// Add cluster count
					map.addLayer({
						id: 'cluster-count',
						type: 'symbol',
						source: 'events',
						filter: ['has', 'point_count'],
						layout: {
							'text-field': '{point_count_abbreviated}',
							'text-font': ['inter-medium'],
							'text-size': 12
						},
						paint: {
							'text-color': 'hsl(0, 0%, 100%)'
						},
						'maxzoom': zoomThreshold
					});

					map.setLight({
						'anchor': 'viewport',
						'color': 'hsl(0, 0%, 100%)',
						'intensity': 0.5,
						'position': [1.15, 210, 40]
					});

                    // Handle clicks on category filter
                    document.addEventListener('click', (e) => {
                        const categoryFeatureElement = e.target.closest('.category-feature');
                        if (!categoryFeatureElement) return;

                        const category = categoryFeatureElement.dataset.category;
                        if (!category) return;

                        // Close any open popup when clicking a category
                        if (window.featurePopup) {
                            window.featurePopup.remove();
                            window.featurePopup = null;
                        }

                        // Remove all activeCategory classes first
                        document.querySelectorAll('.category-feature.activeCategory').forEach(el => {
                            el.classList.remove('activeCategory');
                        });

                        // Toggle logic
                        if (currentActiveCategory === category) {
                            // Second click on same category - remove filter
                            filterLocation('all'); // Show all features
                            categoryFeatureElement.classList.remove('activeCategory');
                            currentActiveCategory = 'all';
                        } else {
                            // New category selected
                            filterLocation(category);
                            categoryFeatureElement.classList.add('activeCategory');
                            currentActiveCategory = category;
                        }
                    });

				});
		});

		const filterLocation = (category) => {
			if (!locationData) return;

			const filtered = {
				...locationData,
				features: category === 'all'
					? locationData.features
					: locationData.features.filter(f => f.properties.start_date_iso?.startsWith(category))
			};

			map.getSource('events').setData(filtered);

			currentActiveCategory = category;
			//updateMarkers(); // now update markers as usual
		};

		const createCategoryBox = () => {
			const categoryBox = document.getElementById('category-box');
			categoryBox.innerHTML = '';

			const innerContainer = document.createElement('div');
			innerContainer.className = 'category-box-inner';
			categoryBox.appendChild(innerContainer);

			// Categories
			const categories = [
				{ date: '2025-06-22', day: 'Sunday' },
				{ date: '2025-06-23', day: 'Monday' },
				{ date: '2025-06-24', day: 'Tuesday' },
				{ date: '2025-06-25', day: 'Wednesday' },
				{ date: '2025-06-26', day: 'Thursday' },
				{ date: '2025-06-27', day: 'Friday' },
			];

			categories.forEach(({ date, day }) => {
				const categoryElement = document.createElement('div');
				categoryElement.className = 'category-feature';
				categoryElement.dataset.category = date;

				// Create text span
				const textSpan = document.createElement('span');
				textSpan.textContent = day;

				// Append elements
				categoryElement.appendChild(textSpan);
				innerContainer.appendChild(categoryElement);
			});
		};

        map.once('idle', () => {
            createCategoryBox();
        });

	</script>
</body>

</html>